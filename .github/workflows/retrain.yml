name: Retrain - Automated Retraining

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for retraining'
        required: false
        default: 'manual'
      min_accuracy:
        description: 'Minimum accuracy threshold'
        required: false
        default: '0.75'
  # Can be triggered by monitoring workflow or manually
  repository_dispatch:
    types: [retrain-trigger]

env:
  PYTHON_VERSION: '3.10'
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || './mlflow' }}

jobs:
  check-trigger:
    name: Check Retraining Trigger
    runs-on: ubuntu-latest
    outputs:
      should_retrain: ${{ steps.check.outputs.should_retrain }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trigger file
        id: check
        run: |
          if [ -f ".github/triggers/retrain_trigger.json" ]; then
            echo "should_retrain=true" >> $GITHUB_OUTPUT
            echo "âœ… Retraining trigger found"
            cat .github/triggers/retrain_trigger.json
          else
            echo "should_retrain=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Manual trigger - proceeding with retraining"
          fi

  retrain:
    name: Retrain Model
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_retrain == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Fetch latest data
        run: |
          mkdir -p data/{raw,processed}
          python -c "
          from sklearn.datasets import fetch_california_housing
          import pandas as pd
          data = fetch_california_housing(as_frame=True)
          df = data.frame
          df.to_csv('data/raw/housing.csv', index=False)
          print(f'âœ… Fetched {len(df)} samples')
          "

      - name: Train new model
        run: |
          echo "ðŸŽ¯ Training new model with fresh data..."
          python src/models/train.py \
            --experiment-name "automated-retraining" \
            --run-name "retrain-$(date +%Y%m%d-%H%M%S)"
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}

      - name: Validate new model
        id: validate
        run: |
          echo "âœ… Running validation tests..."
          python scripts/validate_model.py \
            --min-accuracy ${{ github.event.inputs.min_accuracy || '0.75' }} \
            --output validation_results.json
          
          if [ $? -eq 0 ]; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Register model in MLflow
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          echo "ðŸ“¦ Registering model in MLflow Model Registry..."
          python scripts/register_model.py \
            --model-name "production-model" \
            --stage "Staging"

      - name: Promote to production
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          echo "ðŸš€ Promoting model to production..."
          python scripts/promote_model.py \
            --model-name "production-model" \
            --stage "Production"

      - name: Update reference data
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          echo "ðŸ”„ Updating reference data for drift detection..."
          python scripts/update_reference_data.py

      - name: Clean up trigger file
        if: always()
        run: |
          rm -f .github/triggers/retrain_trigger.json
          echo "ðŸ§¹ Trigger file cleaned up"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: retraining-artifacts
          path: |
            validation_results.json
            mlflow/

      - name: Summary
        if: always()
        run: |
          echo "# ðŸ”„ Retraining Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event.inputs.reason || 'automated' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Validation**: ${{ steps.validate.outputs.validation_passed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
